<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Mood Mirror</title>
  <meta name="description" content="Webcam-based facial expression analyzer with live mood chart. 100% front-end, ready for GitHub Pages." />
  <style>
    :root{
      --bg:#0b0f1a; --panel:#101830; --ink:#e8eeff; --muted:#a4b3ff; --accent:#6ea8ff; --ok:#2ecc71; --warn:#f5a524; --bad:#ff4d4f;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 70% -10%,#1b2440 0%,#0b0f1a 60%,#060913 100%);color:var(--ink);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Inter,Helvetica,Arial}
    .wrap{display:grid;grid-template-columns:1.1fr 1fr;gap:16px;max-width:1100px;margin:24px auto;padding:0 16px}
    header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    h1{font-weight:800;letter-spacing:.3px;margin:0;font-size:22px}
    .tag{opacity:.8;font-size:12px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00));border:1px solid #2b365e55;border-radius:14px;box-shadow:0 10px 30px #0008;}
    .panel{padding:14px}

    /* left column: camera */
    .cam{position:relative;overflow:hidden}
    video,canvas#overlay{width:100%;height:auto;display:block;border-radius:12px}
    video{filter:contrast(1.05) saturate(1.05);background:#000}
    .hud{position:absolute;inset:auto 10px 10px 10px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .pill{background:rgba(5,10,25,.65);backdrop-filter:blur(8px);border:1px solid #2b365e80;color:var(--ink);padding:8px 10px;border-radius:999px;display:flex;align-items:center;gap:8px}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .btn{all:unset;cursor:pointer;background:linear-gradient(180deg,#1a2550,#121b3b);border:1px solid #2b365e;box-shadow:inset 0 1px 0 #7aa2ff22,0 10px 20px #0007;color:var(--ink);padding:8px 12px;border-radius:10px;font-weight:600}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    /* right column: charts */
    .charts{display:grid;gap:12px;grid-template-rows:auto 1fr}
    .bar{padding:10px 12px}
    .bar h3{margin:0 0 8px 0;font-size:13px;opacity:.9}
    .bar .row{display:grid;grid-template-columns:90px 1fr 60px;gap:8px;align-items:center;margin:6px 0}
    progress{width:100%;height:10px;-webkit-appearance:none;appearance:none;border-radius:8px;overflow:hidden;background:#2b365e44}
    progress::-webkit-progress-bar{background:#2b365e44}
    progress::-webkit-progress-value{background:linear-gradient(90deg,var(--accent),#b3d0ff)}

    .chart-wrap{padding:8px 12px 12px}
    canvas#trend{width:100%;height:260px;background:conic-gradient(from 180deg at 50% 120%, #0f1835, #0d1631);border-radius:10px;border:1px solid #2b365e55}

    footer{grid-column:1/-1;opacity:.7;text-align:center;margin:8px 0 18px 0;font-size:12px}
    a{color:#9bb7ff}

    @media (max-width: 900px){
      .wrap{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>AI Mood Mirror</h1>
        <div class="tag">Live facial-expression analyzer — runs entirely in your browser.</div>
      </div>
      <div class="pill"><span id="statusDot" class="dot bad"></span><span id="statusText">Loading models…</span></div>
    </header>

    <section class="cam card">
      <div class="panel" style="padding:10px 10px 0 10px">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="overlay"></canvas>
      </div>
      <div class="hud">
        <div class="pill" id="currentTop">Top mood: —</div>
        <div style="display:flex; gap:8px">
          <button id="flipBtn" class="btn" title="Flip camera">Flip</button>
          <button id="snapBtn" class="btn" title="Save snapshot">Save PNG</button>
        </div>
      </div>
    </section>

    <section class="charts">
      <div class="card bar">
        <h3>Live probabilities</h3>
        <div id="bars"></div>
      </div>
      <div class="card chart-wrap">
        <canvas id="trend"></canvas>
      </div>
    </section>

    <footer>
      Works offline after first load. No video leaves your device. Built with <a href="https://github.com/justadudewhohacks/face-api.js" target="_blank" rel="noreferrer">face-api.js</a> & Canvas.
    </footer>
  </div>

  <!-- Face API (expression detection) -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <!-- Chart.js for the tiny trend graph -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
  // ====== CONFIG ======
  const MODEL_URL = "https://justadudewhohacks.github.io/face-api.js/models"; // Host your own later: /models
  const EXPRESSIONS = ["neutral","happy","sad","angry","fearful","disgusted","surprised"]; // face-api order

  // ====== DOM ======
  const video = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const statusDot = document.getElementById('statusDot');
  const statusText = document.getElementById('statusText');
  const barsHost = document.getElementById('bars');
  const currentTop = document.getElementById('currentTop');
  const flipBtn = document.getElementById('flipBtn');
  const snapBtn = document.getElementById('snapBtn');

  // ====== STATE ======
  let stream;
  let usingFront = true; // try user-facing first
  let chart;
  const historyLen = 120; // ~ last 60s if sampling ~500ms
  const history = EXPRESSIONS.reduce((acc,k)=>{acc[k]=Array(historyLen).fill(0);return acc;},{});

  // ====== UI: build probability bars ======
  function makeBars(){
    barsHost.innerHTML = '';
    EXPRESSIONS.forEach(name => {
      const row = document.createElement('div'); row.className='row';
      const label = document.createElement('div'); label.textContent = name;
      const prog = document.createElement('progress'); prog.max = 1; prog.value = 0; prog.id = `bar-${name}`;
      const pct = document.createElement('div'); pct.id = `pct-${name}`; pct.style.textAlign='right'; pct.style.opacity=.9; pct.textContent='0%';
      row.append(label, prog, pct);
      barsHost.appendChild(row);
    });
  }

  // ====== Camera control ======
  async function startCamera(){
    if(stream){ stream.getTracks().forEach(t=>t.stop()); }
    const constraints = { audio:false, video:{ facingMode: usingFront? 'user':'environment', width:{ideal: 960}, height:{ideal: 540} } };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    await new Promise(r=> video.onloadedmetadata = r);
    // resize overlay to video
    overlay.width = video.videoWidth; overlay.height = video.videoHeight;
  }

  flipBtn.onclick = async()=>{ usingFront = !usingFront; await startCamera(); };

  snapBtn.onclick = ()=>{
    const snap = document.createElement('canvas');
    snap.width = overlay.width; snap.height = overlay.height;
    const ctx = snap.getContext('2d');
    ctx.drawImage(video,0,0); // frame
    ctx.drawImage(overlay,0,0); // landmarks overlay
    const url = snap.toDataURL('image/png');
    const a = document.createElement('a'); a.href = url; a.download = `mood-${Date.now()}.png`; a.click();
  };

  // ====== Trend chart ======
  function initChart(){
    const ctx = document.getElementById('trend');
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: Array(historyLen).fill(''),
        datasets: EXPRESSIONS.map((name,i)=>({
          label: name,
          data: history[name],
          tension: 0.25,
          pointRadius: 0,
          borderWidth: 1.5,
        }))
      },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{labels:{color:'#cfe2ff', boxWidth:10, boxHeight:2}}, tooltip:{enabled:true} },
        scales:{
          x:{ ticks:{display:false}, grid:{display:false}, border:{display:false} },
          y:{ min:0, max:1, ticks:{display:false}, grid:{color:'#2b365e33'}, border:{display:false} }
        }
      }
    });
  }

  function pushHistory(probs){
    EXPRESSIONS.forEach(k=>{
      history[k].push(probs[k]||0);
      if(history[k].length>historyLen) history[k].shift();
    });
    chart.update('none');
  }

  // ====== Overlay drawing ======
  function drawOverlay(detection){
    const ctx = overlay.getContext('2d');
    ctx.clearRect(0,0,overlay.width,overlay.height);
    if(!detection) return;

    // Draw box
    const { x, y, width, height } = detection.detection.box;
    ctx.strokeStyle = 'rgba(110,168,255,.9)';
    ctx.lineWidth = 2;
    ctx.strokeRect(x,y,width,height);

    // Draw landmarks (sparse)
    const lm = detection.landmarks.positions;
    ctx.fillStyle = 'rgba(110,168,255,.85)';
    for(let i=0;i<lm.length;i+=5){
      const p = lm[i];
      ctx.beginPath(); ctx.arc(p.x,p.y,1.5,0,Math.PI*2); ctx.fill();
    }

    // Label top expression
    const expr = detection.expressions.asSortedArray()[0];
    ctx.fillStyle = 'rgba(5,10,25,.7)';
    ctx.fillRect(x, y-24, 120, 20);
    ctx.strokeStyle = '#2b365e';
    ctx.strokeRect(x, y-24, 120, 20);
    ctx.fillStyle = '#d9e6ff';
    ctx.font = '12px ui-sans-serif';
    ctx.fillText(`${expr.expression}: ${(expr.probability*100).toFixed(0)}%`, x+8, y-10);
  }

  // ====== Detection loop ======
  async function detectLoop(){
    if(video.readyState >= 2){
      const result = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({scoreThreshold:0.5}))
        .withFaceLandmarks()
        .withFaceExpressions();

      if(result){
        drawOverlay(result);
        const probs = result.expressions;
        // update bars
        let topName = '—', topVal = 0;
        EXPRESSIONS.forEach(name=>{
          const v = probs[name] || 0;
          const bar = document.getElementById(`bar-${name}`);
          const pct = document.getElementById(`pct-${name}`);
          if(bar){ bar.value = v; }
          if(pct){ pct.textContent = `${Math.round(v*100)}%`; }
          if(v>topVal){ topVal=v; topName=name; }
        });
        currentTop.textContent = `Top mood: ${topName} ${Math.round(topVal*100)}%`;
        pushHistory(probs);
        setStatus(true, 'Live');
      } else {
        const ctx = overlay.getContext('2d');
        ctx.clearRect(0,0,overlay.width,overlay.height);
        setStatus(false, 'No face detected');
      }
    }
    // aim for ~10–12fps processing to keep CPU chill
    setTimeout(()=>requestAnimationFrame(detectLoop), 80);
  }

  function setStatus(ok, text){
    statusDot.className = 'dot ' + (ok ? 'ok' : 'bad');
    statusText.textContent = text;
  }

  // ====== Boot ======
  async function boot(){
    makeBars();
    initChart();

    // Permissions & camera
    try{ await startCamera(); } catch(e){
      alert('Camera permission denied or unavailable.');
      setStatus(false, 'Camera blocked');
      return;
    }

    // Load models
    setStatus(false, 'Loading models…');
    await Promise.all([
      faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
      faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
      faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL),
    ]);

    setStatus(true, 'Models ready');
    detectLoop();
  }

  // PWA-ish offline cache (very small & optional)
  if('serviceWorker' in navigator){
    window.addEventListener('load',()=>{
      const sw = URL.createObjectURL(new Blob([`
        const CACHE='aimoodmirror-v1';
        self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])))});
        self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)))});
      `],{type:'text/javascript'}));
      navigator.serviceWorker.register(sw);
    });
  }

  boot();
  </script>
</body>
</html>
